# External Integrations

**Analysis Date:** 2026-02-19

## APIs & External Services

**None explicitly configured**

The outbox framework is designed as a minimal, self-contained library with no external service dependencies. Integration points are abstracted through SPI (Service Provider Interface) contracts, allowing downstream applications to plug in their own implementations.

## Data Storage

**Databases:**

- **H2** 2.2.224
  - Supported: In-memory or file-based
  - Used by: All tests, `outbox-demo`, `outbox-spring-demo`
  - Client: JDBC via `AbstractJdbcOutboxStore` (H2 subclass: `H2OutboxStore`)
  - Connection: Via `javax.sql.DataSource` abstraction

- **MySQL** 5.7+
  - JDBC Driver: `mysql-connector-j` 8.3.0
  - Client: JDBC via `AbstractJdbcOutboxStore` (MySQL subclass: `MySqlOutboxStore`)
  - Specialization: `DELETE...ORDER BY...LIMIT` support for efficient row claiming

- **PostgreSQL** 10+
  - JDBC Driver: `postgresql` 42.7.3
  - Client: JDBC via `AbstractJdbcOutboxStore` (PostgreSQL subclass: `PostgresOutboxStore`)
  - Specialization: `FOR UPDATE SKIP LOCKED` + `RETURNING` for row locking

**Connection Management:**

- Abstraction: `outbox.spi.ConnectionProvider` interface
- Implementation: `outbox.jdbc.DataSourceConnectionProvider` - wraps `javax.sql.DataSource`
- Pool: Optional `com.zaxxer.HikariCP` 5.1.0 (used in benchmarks, not required)
- Spring Integration: `outbox.spring.SpringTxContext` bridges Spring's `DataSourceUtils` for Spring-managed connections

**Schema:**

- Auto-created on startup (samples use Spring's `spring.sql.init.mode=always`)
- Schema SQL: `samples/outbox-spring-demo/src/main/resources/schema.sql`
- Single table: `OUTBOX` with columns: `event_id`, `event_type`, `aggregate_type`, `aggregate_id`, `tenant_id`, `occurred_at`, `payload`, `headers`, `status`, `created_at`, `updated_at`
- Status enum: PENDING, DISPATCHING, DONE, RETRY, DEAD

## File Storage

**Not applicable**

Events are persisted only to the configured relational database. No file storage integration.

## Caching

**None configured**

No caching layer or distributed cache integration. In-flight event deduplication uses in-memory `DefaultInFlightTracker` (duration-based TTL, periodic eviction).

## Authentication & Identity

**GitHub OAuth (Publishing Only)**

- Service: GitHub Packages (Maven repository)
- Scope: Publishing library artifacts
- Auth Method: `GITHUB_TOKEN` environment variable (GitHub Actions secret)
- Configured in: `.github/workflows/publish.yml`
- Maven config: Auto-generated by `setup-java` action with `server-id: github`
- Repository URL: `https://maven.pkg.github.com/leonlee/outbox`

**No App-Level Auth:**

- The framework provides no built-in authentication for event listeners or API endpoints
- Applications using the framework must implement their own auth (example: Spring Security in `outbox-spring-demo`)

## Transaction Management

**Abstraction Layer:**

- Interface: `outbox.spi.TxContext`
- Implementations:
  - `outbox.jdbc.tx.ThreadLocalTxContext` - Manual JDBC transaction management (ThreadLocal storage of active connection + transaction state)
  - `outbox.jdbc.tx.JdbcTransactionManager` - Executor for manual commit/rollback
  - `outbox.spring.SpringTxContext` - Spring Framework integration (`TransactionSynchronizationManager`, `DataSourceUtils`)

**Lifecycle:**

- `isTransactionActive()` - Check if a transaction is in-flight
- `currentConnection()` - Get the connection for the active transaction
- `afterCommit(Runnable)` - Register callback to run after successful commit
- `afterRollback(Runnable)` - Register callback to run after rollback

**Spring Integration:**

- Class: `outbox.spring.SpringTxContext`
- Depends on: `org.springframework:spring-jdbc`, `org.springframework:spring-tx` (provided scope)
- Usage: Registered in Spring config (see `OutboxConfiguration` in samples)
- Bridges: Obtains connections via `DataSourceUtils.getConnection()` and registers callbacks via `TransactionSynchronizationManager.registerSynchronization()`

## Monitoring & Observability

**Metrics Export:**

- Interface: `outbox.spi.MetricsExporter`
- Implementation: `outbox.micrometer.MicrometerMetricsExporter` (Micrometer bridge)
- Library: `io.micrometer:micrometer-core` 1.14.5 (provided scope - optional)

**Exported Metrics:**

**Counters:**
- `outbox.enqueue.hot` - Events enqueued via hot path (afterCommit)
- `outbox.enqueue.hot.dropped` - Events dropped (hot queue full, fallback to poller)
- `outbox.enqueue.cold` - Events enqueued via cold path (poller discovery)
- `outbox.dispatch.success` - Events dispatched successfully (marked DONE)
- `outbox.dispatch.failure` - Events failed (marked RETRY, will retry per policy)
- `outbox.dispatch.dead` - Events moved to DEAD (unroutable or max retries exceeded)

**Gauges:**
- `outbox.queue.hot.depth` - Current hot queue size (integer)
- `outbox.queue.cold.depth` - Current cold queue size (integer)
- `outbox.lag.oldest.ms` - Age of oldest pending event in milliseconds

**Custom Prefix:**

- Constructor: `MicrometerMetricsExporter(MeterRegistry registry, String namePrefix)`
- Example: `namePrefix = "orders.outbox"` produces metrics like `orders.outbox.dispatch.success`

**Supported Backends:**

- Prometheus (default Micrometer export)
- Grafana (consumes Prometheus)
- Datadog (Micrometer Datadog exporter)
- Any Micrometer-compatible registry

**Logging:**

- Framework: `java.util.logging` (JDK built-in)
- Level: Used for errors, warnings in event dispatch, transaction callbacks
- No external logging backend required (applications can bridge to SLF4J/Logback)
- Sample uses: `org.slf4j` via Spring Boot (application-level, not framework)

## CI/CD & Deployment

**Hosting:**

- GitHub (https://github.com/leonlee/outbox)
- Packages: Maven Central via GitHub Packages (`https://maven.pkg.github.com/leonlee/outbox`)

**CI Workflows:**

- **ci.yml** - Triggered on push/PR
  - Java 17 and 21 matrix
  - Runs: `mvn -B verify` (all tests)
  - Actions: `actions/checkout@v6`, `actions/setup-java@v5`

- **publish.yml** - Triggered on `v*` tags
  - Validates: Tag version matches POM version
  - Builds: `mvn -B verify`
  - Publishes: `mvn -B -pl outbox-core,outbox-jdbc,outbox-spring-adapter,outbox-micrometer -am deploy -DskipTests`
  - Creates: GitHub Release with auto-generated notes via `gh release create`
  - Env: `GITHUB_TOKEN` secret

- **benchmark.yml** - Manual or scheduled
  - Runs: JMH benchmarks
  - Generates: Performance reports
  - Artifacts: Published to GitHub

- **docs.yml** - Triggered on changes to docs files
  - Path-filtered for efficiency
  - Builds and publishes documentation

- **schema-diff.yml** - Schema validation
  - Compares database schemas across versions

**Dependabot:**

- Configured in: `.github/dependabot.yml`
- Monitors: GitHub Actions, Maven dependencies
- Auto-updates: Version bumps, security patches
- Target: `main` branch

## Webhooks & Callbacks

**Incoming:**

- None configured at framework level
- Applications using the framework can implement REST endpoints (e.g., event ingestion)
- Sample: `outbox-spring-demo` provides POST `/events/user-created` and `/events/order-placed`

**Outgoing:**

- Framework provides no outgoing webhooks
- Applications dispatch events to listeners via `EventListener` interface (in-process)
- Dead event replay available via `DeadEventManager.replayDead()` (manual API, not webhook)

**Event Callback Lifecycle:**

- `WriterHook.beforeWrite()` - Before DB insert (may transform events)
- `WriterHook.afterWrite()` - After DB insert (observational)
- `WriterHook.afterCommit()` - After transaction commit (enqueue to dispatcher hot path)
- `WriterHook.afterRollback()` - After transaction rollback (no-op for events)

- `EventInterceptor.beforeDispatch()` - Before listener invocation (audit/logging)
- `EventInterceptor.afterDispatch()` - After listener completes (success/failure handling)

## Environment Configuration

**Required Environment Variables:**

None for the framework itself. Applications using the framework configure via:

**Spring Boot Applications (e.g., outbox-spring-demo):**
- `spring.datasource.url` - JDBC connection string
- `spring.datasource.driver-class-name` - Driver class
- `spring.datasource.username` - DB username
- `spring.datasource.password` - DB password (should use `secrets/` in production)
- `server.port` - HTTP server port (default 8080)

**GitHub Actions (CI/CD):**
- `GITHUB_TOKEN` - Auto-provided by Actions, used for publishing and releasing

**Secrets Location:**

- GitHub Secrets: `.github/workflows/publish.yml` references `${{ secrets.GITHUB_TOKEN }}`
- Database Credentials: Application-level (Spring Boot properties or environment variables)
- No hardcoded secrets in repository

## Extensibility Points (SPI)

The framework defines several extension interfaces for custom implementations:

**`outbox.spi.TxContext`**
- Purpose: Abstract transaction lifecycle
- Used by: `OutboxWriter`, `OutboxDispatcher`
- Implementations: `ThreadLocalTxContext`, `SpringTxContext`

**`outbox.spi.ConnectionProvider`**
- Purpose: Abstract connection acquisition
- Used by: `OutboxDispatcher`, `OutboxPoller`, `DeadEventManager`
- Implementation: `DataSourceConnectionProvider`

**`outbox.spi.OutboxStore`**
- Purpose: Persistence contract (insert, mark done/retry/dead, poll, claim)
- Used by: `OutboxWriter`, `OutboxDispatcher`, `OutboxPoller`
- Implementation: `AbstractJdbcOutboxStore` hierarchy (H2, MySQL, PostgreSQL)

**`outbox.spi.EventPurger`**
- Purpose: Purge old/terminal events
- Used by: `OutboxPurgeScheduler`
- Implementations: `AbstractJdbcEventPurger` hierarchy (status-based), `AbstractJdbcAgeBasedPurger` hierarchy (CDC mode)

**`outbox.spi.MetricsExporter`**
- Purpose: Export metrics
- Used by: `OutboxDispatcher`, `OutboxPoller`, `DispatcherWriterHook`
- Implementation: `MicrometerMetricsExporter`

**`outbox.util.JsonCodec`**
- Purpose: Serialize/deserialize event headers (Map<String,String> â†” JSON)
- Used by: `AbstractJdbcOutboxStore`, `OutboxPoller`
- Implementation: `DefaultJsonCodec` (built-in, zero-dependency)

**`outbox.EventListener`**
- Purpose: Handle dispatched events
- Used by: `OutboxDispatcher` (via `ListenerRegistry`)
- User-provided: Applications implement to handle events

**`outbox.dispatch.EventInterceptor`**
- Purpose: Cross-cutting hooks (audit, logging, metrics)
- Used by: `OutboxDispatcher` (before/after dispatch)
- User-provided: Applications implement for custom behaviors

---

*Integration audit: 2026-02-19*
