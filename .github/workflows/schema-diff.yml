name: Schema Diff

on:
  pull_request:
    branches: [main]
    paths:
      - 'outbox-jdbc/src/main/resources/schema/**'

permissions:
  pull-requests: write

jobs:
  schema-diff:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: outbox
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: outbox
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          path: pr

      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          ref: main
          path: main

      - name: Install sqldef
        run: |
          SQLDEF_VERSION=v0.17.22
          curl -sL "https://github.com/sqldef/sqldef/releases/download/${SQLDEF_VERSION}/mysqldef_linux_amd64.tar.gz" | tar xz -C /usr/local/bin mysqldef
          curl -sL "https://github.com/sqldef/sqldef/releases/download/${SQLDEF_VERSION}/psqldef_linux_amd64.tar.gz" | tar xz -C /usr/local/bin psqldef
          chmod +x /usr/local/bin/mysqldef /usr/local/bin/psqldef

      - name: Generate schema diffs
        id: diff
        run: |
          SCHEMA_DIR="outbox-jdbc/src/main/resources/schema"
          RESULT=""

          # --- H2 (text diff, no sqldef binary) ---
          RESULT+="### H2\n"
          if [ -f "main/${SCHEMA_DIR}/h2.sql" ]; then
            H2_DIFF=$(diff -u "main/${SCHEMA_DIR}/h2.sql" "pr/${SCHEMA_DIR}/h2.sql" || true)
            if [ -z "$H2_DIFF" ]; then
              RESULT+="No changes.\n"
            else
              RESULT+="\`\`\`diff\n${H2_DIFF}\n\`\`\`\n"
            fi
          else
            RESULT+="New file (no baseline on main).\n"
          fi

          # --- MySQL ---
          RESULT+="\n### MySQL\n"
          if [ -f "main/${SCHEMA_DIR}/mysql.sql" ] && [ -f "pr/${SCHEMA_DIR}/mysql.sql" ]; then
            MYSQL_PWD=root mysqldef -u root -h 127.0.0.1 --port 3306 outbox < "main/${SCHEMA_DIR}/mysql.sql"
            MYSQL_DIFF=$(MYSQL_PWD=root mysqldef -u root -h 127.0.0.1 --port 3306 outbox --dry-run < "pr/${SCHEMA_DIR}/mysql.sql")
            if echo "$MYSQL_DIFF" | grep -q "^--"; then
              RESULT+="No changes.\n"
            else
              RESULT+="\`\`\`sql\n${MYSQL_DIFF}\n\`\`\`\n"
            fi
          elif [ -f "pr/${SCHEMA_DIR}/mysql.sql" ]; then
            MYSQL_DIFF=$(MYSQL_PWD=root mysqldef -u root -h 127.0.0.1 --port 3306 outbox --dry-run < "pr/${SCHEMA_DIR}/mysql.sql")
            RESULT+="\`\`\`sql\n${MYSQL_DIFF}\n\`\`\`\n"
          elif [ -f "main/${SCHEMA_DIR}/mysql.sql" ]; then
            RESULT+="File deleted in PR.\n"
          else
            RESULT+="No file found.\n"
          fi

          # --- PostgreSQL ---
          RESULT+="\n### PostgreSQL\n"
          if [ -f "main/${SCHEMA_DIR}/postgresql.sql" ] && [ -f "pr/${SCHEMA_DIR}/postgresql.sql" ]; then
            PGPASSWORD=postgres psqldef -U postgres -h 127.0.0.1 --port 5432 outbox < "main/${SCHEMA_DIR}/postgresql.sql"
            PG_DIFF=$(PGPASSWORD=postgres psqldef -U postgres -h 127.0.0.1 --port 5432 outbox --dry-run < "pr/${SCHEMA_DIR}/postgresql.sql")
            if echo "$PG_DIFF" | grep -q "^--"; then
              RESULT+="No changes.\n"
            else
              RESULT+="\`\`\`sql\n${PG_DIFF}\n\`\`\`\n"
            fi
          elif [ -f "pr/${SCHEMA_DIR}/postgresql.sql" ]; then
            PG_DIFF=$(PGPASSWORD=postgres psqldef -U postgres -h 127.0.0.1 --port 5432 outbox --dry-run < "pr/${SCHEMA_DIR}/postgresql.sql")
            RESULT+="\`\`\`sql\n${PG_DIFF}\n\`\`\`\n"
          elif [ -f "main/${SCHEMA_DIR}/postgresql.sql" ]; then
            RESULT+="File deleted in PR.\n"
          else
            RESULT+="No file found.\n"
          fi

          # Write to file for the comment step
          echo -e "$RESULT" > /tmp/schema-diff.md

      - name: Post PR comment
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/schema-diff.md', 'utf8');
            const marker = '<!-- schema-diff-bot -->';
            const comment = `${marker}\n## Schema Diff\n\n${body}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }
